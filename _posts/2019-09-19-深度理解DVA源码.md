---
layout:     post
title:      深度理解DVA源码

subtitle:   第二篇
date:       2019-09-19
author:     Laqudee.Z
header-img: img/post-bg-debug.png
catalog:    true
tag:
    - Front End
    - dva/react
---

> [笔记参考文档](https://dvajs.com/guide/source-code-explore.html#src-index-js-2)

> 上一篇 ▶️ [《深度理解DVA源码》（第二篇）](https://zhaoylong.github.io/2019/09/16/%E6%B7%B1%E5%BA%A6%E7%90%86%E8%A7%A3DVA%E6%BA%90%E7%A0%81/)

## src/index.js
为什么不直接在start方式中```oldAppStart```？  
- 因为 dva-core 的 start 方法里有用到 this，不用 call 指定调用者为 app 的话，oldAppStart() 会找错对象。

实现代理模式一定要用到call？
- 不一定，看有没有 使用 this 或者代理的函数是不是箭头函数。从另一个角度来说，如果使用了 function 关键字又在内部使用了 this，那么一定要用 call/apply/bind 指定 this。

前端还有哪里会用到call？
- 就实际开发来讲，因为已经使用了 es6 标准，基本和 this 没什么打交道的机会。使用 class 类型的组件中偶尔还会用到 this.xxx.bind(this)，stateless 组件就洗洗睡吧(因为压根没有 this)。如果实现代理，可以使用继承/反向继承的方法 —— 比如高阶组件。

使用```react-redux```的高阶组件传递store
- 经过call代理后的start方法的主要作用，便是使用```react-redux```的provider组件将数据与视图联系了起来，生成React元素呈现给使用者。    
```jsx
//使用 querySelector 获得 dom
if (isString(container)) {
  container = document.querySelector(container);
  invariant(
    container,
    `[app.start] container ${container} not found`,
  );
}
// 其他代码

// 实例化 store
oldAppStart.call(app); 
const store = app._store;

// export _getProvider for HMR
// ref: https://github.com/dvajs/dva/issues/469
app._getProvider = getProvider.bind(null, store, app);

// If has container, render; else, return react component
// 如果有真实的 dom 对象就把 react 拍进去
if (container) {
  render(container, store, app, app._router);
  // 热加载在这里
  app._plugin.apply('onHmr')(render.bind(null, container, store, app));
} else {
  // 否则就生成一个 react ，供外界调用
  return getProvider(store, this, this._router);
}
  
 // 使用高阶组件包裹组件
function getProvider(store, app, router) {
  return extraProps => (
    <Provider store={store}>
      { router({ app, history: app._history, ...extraProps }) }
    </Provider>
  );
}

// 真正的 react 在这里
function render(container, store, app, router) {
  const ReactDOM = require('react-dom');  // eslint-disable-line
  ReactDOM.render(React.createElement(getProvider(store, app, router)), container);
}
```