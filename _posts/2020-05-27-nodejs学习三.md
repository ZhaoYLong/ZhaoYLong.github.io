---
layout:     post
title:      node学习笔记

subtitle:   实现基于TCP与UDP的数据通信
date:       2020-05-27
header-img: img/post-bg-debug.png
catalog:    false
tag:
    - node.js
---

> 在Node.js中，提供了一个net模块与一个dgram模块，分别用于实现基于TCP的数据通信以及基于UDP的数据通信

- 创建TCP服务器
- 使用TCP服务器监听客户端连接的socket端口对象读取客户端发送的数据
- 创建TCP客户端以及利用客户端用于连接TCP服务器的socket端口对象向客户端发送数据    
- 创建UDP服务器与UDP客户端，实现UDP客户端与UDP服务器之间的通信
- 从UDP服务器向客户端广播数据，从UDP服务器向客户端组播数据

## 1 使用net模块实现基于TCP的数据通信

### 1.1 创建TCP服务器
- 在node.js中，可以很方便地创建一个TCP服务器，只需要调用net模块的createServer方法

```js
var server = net.createServer([options], [connectionListener])
```

- 可选参数：
  - options: 对象；可以在该对象中使用一个布尔类型的allowHalfOpen属性
    - false: 当TCP服务器接收到客户端发送的一个FIN包时将会回发一个FIN包    
    - true：TCP服务端接收到客户端发送的FIN包时不回发FIN包，TCP继续向客户端发送数据，当不再继续接收客户端发送的数据。开发者必须调用end方法来关闭socket连接    
    - allowHalfOpen默认属性为false   
  - connectionListener: 指当客户端与服务端建立连接时所调用的回调函数
  
  ```js
  function (socket) {
      // 回调函数代码
  }
  ```

    - 在该回调函数中使用一个参数，参数值为该TCP服务器监听的socket端口对象

```js
server.on('connection', function (socket) {
    // 回调函数代码
})
```

- 在创建TCP服务器之后，使用listen方法通知服务器开始监听客户端连接

```js
// 方法一
server.listen(port, [host], [backlog], [callback])

// 方法二
server.listen(path,[callback])

// 方法三
server.listen(handle, [callback])

// 其他
server.on('listening', function() {
    // 回调函数
})
```

- 一个简单的实例：

```js
var net = require('net');
var server = net.createServer(function(socket) {
    console.log('客户端与服务端连接已建立')
});

server.listen(8431, 'localhost');
server.on('error', function (e) {
    if (e.code == 'EADDRINUSE') {
        console.log('服务器地址及端口已被占用');
    }
});

var address = server.address();
console.log(address) // 返回一个对象：port， address，family
```

- TCP服务器的getConnections()：查看当前与TCP服务器建立连接的客户连接数量
  - server.getConnections(callback): 异步方法

```js
// 使用getConnections方法查询当前存在的客户端连接数
var net = require('net');
var server = net.createServer(function(socket) {
    server.getConnections(function(err, count){
        console.log('当前存在%d个客户端连接', count);
        server.maxConnections = 2;
        console.log('TCP服务器的最大连接数为%d', server.maxConnections);
    });
})
server.listen(8431, 'localhost');
    console.log('TCP服务器被创建');
```

- 最后使用TCP服务器的close方法显式指定服务器拒绝所有的新客户端连接
  - server.close([callback])

```js
// 使用close方法拒绝新的客户连接请求
var net = require('net');
var server = net.createServer(function(socket) {
    server.close(function () {
        console.log('TCP服务器被关闭');
    })
});
server.listen(8431, 'localhost');
```

### 1.2 socket端口对象

> 使用net.Socket代表一个socket端口对象

- var address = socket.address()

```js
// 实例
// 使用socket端口对象的address()来查看端口地址信息
var net = require('net');
var server = net.createServer();
server.on('connection', function(socket) {
    address = socket.address();
    console.log('socket端口对象的地址信息为%j', address);
});
server.listen(8431, 'localhost');
```

- data事件的回调函数的使用示例

```js
var net = require('net');
var server = net.createServer();
server.on('connection', function(socket) {
    socket.on('data', function (data) {
        console.log(data);
    });
})

server.listen(8431, 'localhost');
```

> 进行到P323